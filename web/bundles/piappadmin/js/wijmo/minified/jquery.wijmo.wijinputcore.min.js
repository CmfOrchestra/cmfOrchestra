/*
 *
 * Wijmo Library 2.0.0b1
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";window.wijinputcore={options:{culture:"",invalidClass:"ui-state-error",nullText:"",showNullText:false,hideEnter:false,disableUserInput:false,buttonAlign:"right",showTrigger:false,showSpinner:false,comboItems:undefined,comboWidth:undefined,comboHeight:undefined,initializing:null,initialized:null,triggerMouseDown:null,triggerMouseUp:null,textChanged:null,invalidInput:null},_create:function(){if(this.element[0].tagName.toLowerCase()!=="input")throw"Target element is not a INPUT";a.effects.save(this.element,["width","height"]);var b=this.element.width();this.element.wrap("<div class='wijmo-wijinput ui-widget ui-helper-clearfix ui-state-default ui-corner-all'><span class='wijmo-wijinput-wrapper'></span></div>");this.element.addClass("wijmo-wijinput-input ui-corner-all").attr({role:"textbox","aria-multiline":false});this.wrapper=this.element.parent();this.outerDiv=this.wrapper.parent();this.outerDiv.width(b);if(this.options.showTrigger){this.triggerBtn=a("<div class='wijmo-wijinput-trigger ui-state-default'><span class='ui-icon ui-icon-triangle-1-s'></span></div>").addClass(this.options.buttonAlign==="left"?"ui-corner-left":"ui-corner-right").attr("role","button").appendTo(this.outerDiv);this.element.attr({role:"combobox","aria-expanded":false})}if(this.options.showSpinner){this.spinner=a("<div class='wijmo-wijinput-spinner wijmo-wijinput-button'></div>");this.spinUp=a("<div class='ui-state-default wijmo-wijinput-spinup'><span class='ui-icon ui-icon-triangle-1-n'></span></div>").attr("role","button");this.spinDown=a("<div class='ui-state-default wijmo-wijinput-spindown'><span class='ui-icon ui-icon-triangle-1-s'></span></div>").attr("role","button");if(!this.options.showTrigger){this.spinUp.addClass(this.options.buttonAlign==="left"?"ui-corner-tl":"ui-corner-tr");this.spinDown.addClass(this.options.buttonAlign==="left"?"ui-corner-bl":"ui-corner-br")}this.spinner.append(this.spinUp).append(this.spinDown).appendTo(this.outerDiv);this.element.attr("role","spinner")}if(this.options.showTrigger&&this.options.showSpinner)this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-spinner-trigger-left":"ui-input-spinner-trigger-right");else{this.options.showTrigger&&this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-trigger-left":"ui-input-trigger-right");this.options.showSpinner&&this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-spinner-left":"ui-input-spinner-right")}this.element.setOutWidth(this.outerDiv.width());this._initialize()},_createTextProvider:function(){return undefined},_beginUpdate:function(){},_endUpdate:function(){},_onTriggerClicked:function(){},_initialize:function(){this.element.data("initializing",true);this._trigger("initializing");this.element.data("preText",this.element.val());this.element.data("elementValue",this.element.val());this.element.data("errorstate",false);this.element.data("breakSpinner",true);this.element.data("prevCursorPos",-1);this.element.data("simulating",false);this._createTextProvider();this._beginUpdate();var c=function(a){return(!a.which?a.button:a.which)===1},d=this.options,b=this;this.triggerBtn&&!d.disabled&&this.triggerBtn.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:function(d){if(!c(d))return;b._addState("active",a(this));b._trigger("triggerMouseDown")},mouseup:function(d){if(!c(d))return;b._stopEvent(d);b._stopSpin();b._removeState("active",a(this));b._trigger("triggerMouseUp");b._onTriggerClicked();b._trySetFocus()}});var e=function(d){if(!c(d))return;b._trySetFocus();b.element.data("breakSpinner",false);b._addState("active",a(this));b._doSpin(a(d.currentTarget).hasClass("wijmo-wijinput-spinup"),true)},f=function(d){if(!c(d))return;b._stopSpin();b._removeState("active",a(this))};this.spinUp&&!d.disabled&&this.spinUp.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:e,mouseup:f});this.spinDown&&!d.disabled&&this.spinDown.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:e,mouseup:f});this.element.bind({"focus.wijinput":a.proxy(this._onFocus,this),"blur.wijinput":a.proxy(this._onBlur,this),"mouseup.wijinput":a.proxy(this._onMouseUp,this),"keypress.wijinput":a.proxy(this._onKeyPress,this),"keydown.wijinput":a.proxy(this._onKeyDown,this),"keyup.wijinput":a.proxy(this._onKeyUp,this),"change.wijinput":a.proxy(this._onChange,this),"paste.wijinput":a.proxy(this._onPaste,this),"drop.wijinput":a.proxy(this._onDrop,this)});this.element.bind("propertychange.wijinput input.wijinput",a.proxy(this._onInput,this));this.element.data("initializing",false);this._resetData();this._endUpdate();this._updateText();this.options.disabled&&this.disable();this._trigger("initialized")},_init:function(){},_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);switch(c){case"buttonAlign":case"showTrigger":case"showSpinner":this._destroy();this._create();break;case"showNullText":this._updateText();break;case"disabled":this.element.attr("disabled",b);this.element[b?"addClass":"removeClass"](this.namespace+"-state-disabled");this.triggerBtn!==undefined&&this.triggerBtn[b?"addClass":"removeClass"](this.namespace+"-state-disabled");this.spinup!==undefined&&this.spinup[b?"addClass":"removeClass"](this.namespace+"-state-disabled");this.spindown!==undefined&&this.spindown[b?"addClass":"removeClass"](this.namespace+"-state-disabled")}},destroy:function(){a.Widget.prototype.destroy.apply(this,arguments);this._destroy()},_destroy:function(){this.wrapper=undefined;this.outerDiv=undefined;this.element.unbind(".wijinput");this.element.removeData("errorstate").removeData("breakSpinner").removeData("prevCursorPos").removeData("simulating").removeData("isPassword").removeClass("wijmo-wijinput-input").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow").removeAttr("aria-expanded");this.element.parent().replaceWith(this.element);this.element.parent().replaceWith(this.element);a.effects.restore(this.element,["width","height"])},widget:function(){return this.outerDiv},_getCulture:function(a){return Globalize.findClosestCulture(a||this.options.culture)},_addState:function(b,a){a.is(":not(.ui-state-disabled)")&&a.addClass("ui-state-"+b)},_removeState:function(a,b){b.removeClass("ui-state-"+a)},_isInitialized:function(){return!this.element.data("initializing")},_setData:function(a){this.setText(a)},_resetData:function(){},_validateData:function(){},getText:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,false,false)},setText:function(a){if(!this._isInitialized())this.element.val(a);else{this._textProvider.set(a);this._updateText()}},selectText:function(a,b){if(this.element.is(":disabled"))return;this.element.wijtextselection(a,b)},focus:function(){if(this.element.is(":disabled"))return;this.element.get(0).focus()},isFocused:function(){return this.outerDiv.hasClass("ui-state-focus")},_raiseTextChanged:function(){var a=this.element.val();if(this.element.data("preText")!==a){this._trigger("textChanged",null,{text:a});this.element.data("preText",a)}},_raiseDataChanged:function(){},_allowEdit:function(){return!(this.element.attr("readOnly")&&this.element.is(":disabled"))},_updateText:function(a){if(!this._isInitialized())return;a=!!a;var b=this.element.wijtextselection();this.element.val(this._textProvider.toString());this.options.text=this._textProvider.toString(true,false,false);if(this.element.is(":disabled"))return;a&&this.selectText(b.start,b.end);this.element.data("prevCursorPos",b.start);this._raiseTextChanged();this._raiseDataChanged()},_trySetFocus:function(){if(!this.isFocused())try{!this.options.disableUserInput&&this.element.focus()}catch(a){}},_deleteSelText:function(b){if(!this._allowEdit())return;var a=this.element.wijtextselection();b=!!b;if(b)if(a.end===a.start)if(a.end>=1){a.end=a.end-1;a.start=a.start-1}else return;else a.end=a.end-1;else a.end=a.end-1;if(a.end<a.start)a.end=a.start;var c=new wijInputResult;this._textProvider.removeAt(a.start,a.end,c);this._updateText();this.selectText(c.testPosition,c.testPosition)},_fireIvalidInputEvent:function(c){if(this._trigger("invalidInput",null,{widget:this,"char":c})===true)return;if(!this.element.data("errorstate")){var b=this.options.invalidClass||"ui-state-error";this.element.data("errorstate",true);var a=this;window.setTimeout(function(){a.outerDiv.removeClass(b);a.element.data("errorstate",false)},100);this.outerDiv.addClass(b)}},_onInput:function(){if(!this._isSimulating()||!this.element.data("ime"))return;this._simulate()},_keyDownPreview:function(){return false},_beforeSimulate:function(a){if(!this.element.data("lastSelection")){this.element.data("lastSelection",this.element.wijtextselection());this.element.data("lastValue",this.element.val())}this.element.data("ime",a);this.element.data("simulating",true)},_isSimulating:function(){return this.element.data("simulating")},_simulate:function(d){var a=this,b=null;if(typeof d==="string")b=d;else{var f=this.element.wijtextselection(),c=this.element.data("lastSelection").start,e=f.end;if(e>=c)b=this.element.val().substring(c,e)}b&&window.setTimeout(function(){if(!a.element.data("lastValue"))return;a.element.val(a.element.data("lastValue"));var e=a.element.data("lastSelection");a.element.wijtextselection(e);a.element.data("batchKeyPress",true);a.element.data("simulating",false);var c=jQuery.Event("keypress");c.ctrlKey=c.altKey=false;for(var d=0;d<b.length;d++){c.which=c.charCode=c.keyCode=b.charCodeAt(d);a._onKeyPress(c)}a.element.data("batchKeyPress",false);a._endSimulate()},1)},_endSimulate:function(){this.element.removeData("ime");this.element.removeData("lastSelection");this.element.removeData("lastValue")},_onKeyDown:function(b){this.element.data("prevCursorPos",-1);if(!this._isInitialized())return;var c=this._getKeyCode(b);if(c===229){this._beforeSimulate(true);return}this._endSimulate();if(this.options.disableUserInput){this._stopEvent(b);return}if(this._keyDownPreview(b)){this._stopEvent(b);return}switch(c){case a.ui.keyCode.UP:this._doSpin(true,false);this._stopEvent(b);return;case a.ui.keyCode.DOWN:this._doSpin(false,false);this._stopEvent(b);return}if(b.ctrlKey)switch(c){case a.ui.keyCode.INSERT:case 67:return}if(b.ctrlKey||b.altKey)return;switch(c){case 112:case 113:case 114:case 115:case 116:case 117:case a.ui.keyCode.TAB:case a.ui.keyCode.CAPSLOCK:case a.ui.keyCode.END:case a.ui.keyCode.HOME:case a.ui.keyCode.CTRL:case a.ui.keyCode.SHIFT:return;case a.ui.keyCode.BACKSPACE:this._deleteSelText(true);this._stopEvent(b);return;case a.ui.keyCode.DELETE:this._deleteSelText(false);this._stopEvent(b);return;case a.ui.keyCode.ENTER:if(!this.options.hideEnter)return;break;case a.ui.keyCode.ESCAPE:this._stopEvent(b);window.setTimeout(a.proxy(this._resetData,this),1);return;case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.ALT:this._stopEvent(b);return}},_onKeyUp:function(b){if(this._isSimulating())return;var c=this._getKeyCode(b);if(!this._isInitialized())return;if(c===a.ui.keyCode.ENTER)return;if(c===a.ui.keyCode.ESCAPE)return;if(this.options.disableUserInput){this._raiseTextChanged();this._raiseDataChanged();return}this._stopEvent(b)},_getKeyCode:function(a){var b=window.navigator.userAgent;return(b.indexOf("iPod")!==-1||b.indexOf("iPhone")!==-1)&&a.which===127?8:a.keyCode||a.which},_keyPressPreview:function(){return false},_onKeyPress:function(b){if(this._isSimulating())return;this.element.data("prevCursorPos",-1);if(this.options.disableUserInput)return;if(!this._allowEdit())return;if(b.ctrlKey&&b.keyCode==119){this._onPaste(b);return}if(b.which===0)return;var d=b.keyCode||b.which;if(d===a.ui.keyCode.BACKSPACE){this._stopEvent(b);return}if(b.ctrlKey||b.altKey)if(d!==a.ui.keyCode.SPACE)return;if(d===a.ui.keyCode.ENTER&&!this.options.hideEnter)return true;if(this._keyPressPreview(b))return;var c=this.element.wijtextselection(),f=String.fromCharCode(d);c.start<c.end&&this._textProvider.removeAt(c.start,c.end-1,new wijInputResult);var e=new wijInputResult,g=this._textProvider.insertAt(f,c.start,e);if(g){this._updateText();this.selectText(e.testPosition+1,e.testPosition+1)}else this._fireIvalidInputEvent(f);!this.element.data("batchKeyPress")&&this._stopEvent(b)},_isNullText:function(){return this.options.showNullText&&this.element.val()===this.options.nullText},_doFocus:function(){var c=this.element.wijtextselection(),b=c.start;this._updateText();var d=this.element.val();if(d.length===b)b=0;!a.browser.safari&&this.selectText(b,b)},_afterFocused:function(){this._isNullText()&&this._doFocus()},_onFocus:function(){if(this.options.disableUserInput)return;this._addState("focus",this.outerDiv);if(!this.element.data("breakSpinner"))return;if(!this._isInitialized())return;if(!this._allowEdit())return;!this.element.data("focusNotCalledFirstTime")&&this.element.data("focusNotCalledFirstTime",+new Date);this._afterFocused()},_onBlur:function(){if(this.options.disableUserInput)return;if(this._isComboListVisible())return;var c=this.isFocused();this._removeState("focus",this.outerDiv);if(!this.element.data("breakSpinner")){this.element.get(0).focus();var a=this.element.data("prevCursorPos");a!==undefined&&a!==-1&&this.selectText(a,a);return}if(!this._isInitialized())return;if(!c)return;this.element.data("value",this.element.val());var b=this;window.setTimeout(function(){b._onChange();b._updateText();b._validateData()},100)},_onMouseUp:function(){if(!this._isInitialized())return;if(this.element.is(":disabled"))return;var a=this.element.wijtextselection();this.element.data("prevCursorPos",a.start)},_onChange:function(){if(!this.element)return;var a=this.element.val(),b=this.getText();b!==a&&this.setText(a)},_onPaste:function(){this._beforeSimulate();var a=this;window.setTimeout(function(){a._simulate()},1)},_onDrop:function(a){this._beforeSimulate();if(a.originalEvent&&a.originalEvent.dataTransfer){var b=a.originalEvent.dataTransfer.getData("Text");b&&this._simulate(b)}},_stopEvent:function(a){a.stopPropagation();a.preventDefault()},_calcSpinInterval:function(){this._repeatingCount++;return this._repeatingCount>10?50:this._repeatingCount>4?100:this._repeatingCount>2?200:400},_doSpin:function(){},_stopSpin:function(){this.element.data("breakSpinner",true);this._repeatingCount=0},_hasComboItems:function(){return!!this.options.comboItems&&this.options.comboItems.length},_isComboListVisible:function(){return!this._comboDiv?false:this._comboDiv.wijpopup("isVisible")},_popupComboList:function(){if(!this._hasComboItems())return;if(!this._allowEdit())return;if(this._isComboListVisible()){this._comboDiv.wijpopup("hide");return}var b=this;if(this._comboDiv===undefined){this._comboDiv=a("<div></div>").appendTo(document.body).width(this.element.width()).height(this.options.comboHeight||180).css("position","absolute");var c=this._normalize(this.options.comboItems);this._comboDiv.wijlist({autoSize:true,maxItemsCount:5,selected:function(c,a){b._setData(a.item.value);b._comboDiv.wijpopup("hide");b._trySetFocus()}});this._comboDiv.wijlist("setItems",c);this._comboDiv.wijlist("renderList");this._comboDiv.wijlist("refreshSuperPanel")}this._comboDiv.wijpopup({autoHide:true});this.outerDiv.attr("aria-expanded",true);this._comboDiv.wijpopup("show",{of:this.outerDiv,offset:"0 4",hidden:function(){b.outerDiv.attr("aria-expanded",false)}})},_normalize:function(b){return b.length&&b[0].label&&b[0].value?b:a.map(b,function(b){return typeof b==="string"?{label:b,value:b}:a.extend({label:b.label||b.value,value:b.value||b.label},b)})}};window.wijInputResult=function(){this.alphanumericCharacterExpected=-2;this.asciiCharacterExpected=-1;this.digitExpected=-3;this.invalidInput=-51;this.letterExpected=-4;this.nonEditPosition=-54;this.positionOutOfRange=-55;this.promptCharNotAllowed=-52;this.signedDigitExpected=-5;this.unavailableEditPosition=-53;this.testPosition=-1};window.wijInputResult.prototype={characterEscaped:1,noEffect:2,sideEffect:3,success:4,unknown:0,hint:0,clone:function(){var a=new wijInputResult;a.hint=this.hint;a.testPosition=this.testPosition;return a}}})(jQuery);